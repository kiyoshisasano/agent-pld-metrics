{
  "path": "pld_runtime/01_schemas/runtime_event_envelope.json",
  "kind": "schema",
  "area": "schema",
  "version": "2.0.0",
  "status_tier": "draft",
  "status_detail": "draft",
  "authority_level": 5,
  "authority_scope": "runtime implementation",
  "purpose": "Runtime envelope template overlaying the Level 1 PLD event schema for valid event emission.",
  "change_classification": "runtime extension + compliance annotation + TODO resolution + editorial clarification",
  "dependencies": [
    "docs/schemas/pld_event.schema.json",
    "docs/event_matrix.yaml",
    "docs/PLD_Runtime_Standard_v2.0.md"
  ],
  "notes": "Resolved TODO: Derived metric staging data (PRDR, VRL)...",
  "license_spdx": "Apache-2.0"
}
{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "PLD Runtime Event Envelope",
  "description": "Level 5 runtime overlay schema used as a template for generating PLD runtime events that comply with Level 1 structure and Level 2 semantics.",
  "type": "object",

  "allOf": [
    {
      "$ref": "../../../docs/schemas/pld_event.schema.json"
    },
    {
      "type": "object",
      "properties": {
        "schema_version": {
          "const": "2.0",
          "description": "Runtime envelope is pinned to PLD schema version 2.0. See Level 2 semantic spec for compatibility guidance."
        },

        "event_id": {
          "type": "string",
          "description": "Runtime MUST generate a unique identifier per event (UUIDv4 RECOMMENDED)."
        },

        "timestamp": {
          "type": "string",
          "format": "date-time",
          "description": "Runtime MUST emit RFC 3339 / ISO-8601 timestamps in UTC."
        },

        "session_id": {
          "type": "string",
          "description": "Runtime session correlation identifier (UUID RECOMMENDED)."
        },

        "turn_sequence": {
          "type": "integer",
          "minimum": 1,
          "description": "Authoritative ordering key. MUST be monotonic and 1-based within a session."
        },

        "turn_id": {
          "type": "string",
          "description": "Optional semantic turn identifier. MUST NOT override ordering defined by turn_sequence."
        },

        "source": {
          "type": "string",
          "enum": [
            "user",
            "assistant",
            "runtime",
            "controller",
            "detector",
            "system"
          ],
          "description": "Logical origin of the event emission."
        },

        "event_type": {
          "type": "string",
          "enum": [
            "drift_detected",
            "drift_escalated",
            "repair_triggered",
            "repair_escalated",
            "reentry_observed",
            "continue_allowed",
            "continue_blocked",
            "failover_triggered",
            "latency_spike",
            "pause_detected",
            "fallback_executed",
            "handoff",
            "evaluation_pass",
            "evaluation_fail",
            "session_closed",
            "info"
          ],
          "description": "Event type MUST satisfy event_type â†’ phase mapping defined in Level 2 event matrix."
        },

        "pld": {
          "type": "object",
          "required": ["phase", "code"],
          "properties": {
            "phase": {
              "type": "string",
              "enum": [
                "drift",
                "repair",
                "reentry",
                "continue",
                "outcome",
                "failover",
                "none"
              ],
              "description": "Lifecycle phase. MUST match lifecycle prefix of pld.code for lifecycle events."
            },

            "code": {
              "type": "string",
              "pattern": "^[A-Z][A-Z0-9]*(?:[0-9]+)?(?:_[a-z0-9]+(?:_[a-z0-9]+)*)?$",
              "description": "Taxonomy-aligned classification code. MUST follow prefix/phase rules from Level 2 and taxonomy from Level 3."
            },

            "confidence": {
              "type": "number",
              "minimum": 0,
              "maximum": 1,
              "description": "Optional classifier confidence score."
            },

            "metadata": {
              "type": "object",
              "additionalProperties": true,
              "description": "Metadata for taxonomy governance and compliance tracking. NOTE: When using Provisional codes (e.g., D9_unspecified or M-prefix events), Level 3 rules MAY require justification fields such as taxonomy_status, reason, or evaluator notes."
            }
          }
        },

        "payload": {
          "type": "object",
          "additionalProperties": true,
          "description": "Runtime- and product-specific payload. Level 1 does not constrain its internal shape."
        },

        "runtime": {
          "type": "object",
          "properties": {
            "latency_ms": {
              "type": "number",
              "description": "End-to-end runtime latency in milliseconds, when available."
            },

            "model": {
              "type": "string",
              "description": "Model identifier used for this turn, when applicable."
            },

            "tool": {
              "type": "string",
              "description": "Non-empty only when a tool invocation occurred."
            },

            "agent_state": {
              "type": "string",
              "description": "Optional opaque agent state identifier."
            }
          },
          "additionalProperties": true,
          "description": "Runtime execution metadata. Additional fields MAY be added at runtime for observability or metric derivation (e.g., storing staging data for M-prefix events)."
        },

        "ux": {
          "type": "object",
          "required": ["user_visible_state_change"],
          "properties": {
            "user_visible_state_change": {
              "type": "boolean",
              "default": false,
              "description": "Indicates whether this event results in a user-visible output. Default false is permitted at Level 5 as a runtime convenience."
            }
          },
          "additionalProperties": false
        },

        "metrics": {
          "type": "object",
          "additionalProperties": true,
          "default": {},
          "description": "Optional runtime metrics snapshot. MUST NOT override downstream metric computation rules."
        },

        "extensions": {
          "type": "object",
          "additionalProperties": true,
          "default": {},
          "description": "Reserved space for experiment tracking and runtime-local extensions."
        }
      }
    }
  ],

  "examples": [
    {
      "schema_version": "2.0",
      "event_id": "00000000-0000-4000-8000-000000000000",
      "timestamp": "2025-01-01T00:00:00Z",
      "session_id": "SESSION_ID_PLACEHOLDER",
      "turn_sequence": 1,
      "source": "runtime",
      "event_type": "continue_allowed",
      "pld": {
        "phase": "continue",
        "code": "C0_normal",
        "confidence": 1.0,
        "metadata": {
          "taxonomy_status": "canonical"
        }
      },
      "payload": {},
      "runtime": {
        "model": "MODEL_ID_PLACEHOLDER",
        "latency_ms": 0
      },
      "ux": {
        "user_visible_state_change": false
      },
      "metrics": {},
      "extensions": {
        "environment": "dev",
        "validation_mode": "strict"
      }
    }
  ]
}




