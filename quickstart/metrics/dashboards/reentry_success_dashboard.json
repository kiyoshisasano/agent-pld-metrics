{
  "version": "1.0",
  "title": "Reentry Success Overview (Demo)",
  "description": "Quickstart dashboard configuration for inspecting reentry-related behavior in PLD event logs. This file is illustrative only and does not define canonical metrics.",
  "data_source": {
    "type": "jsonl",
    "path": "../datasets/pld_events_demo.jsonl",
    "format": "pld_event_v2"
  },
  "filters": {
    "schema_version": "2.0"
  },
  "dimensions": {
    "session_id": "session_id",
    "event_type": "event_type",
    "phase": "pld.phase",
    "code": "pld.code",
    "timestamp": "timestamp"
  },
  "widgets": [
    {
      "id": "reentry_kpi",
      "type": "kpi",
      "title": "Reentry Success Rate (Sessions)",
      "description": "Ratio of sessions that recover after drift and continue, compared to all sessions where drift was detected.",
      "query": {
        "session_scope": true,
        "definitions": {
          "sessions_with_drift": {
            "where": {
              "event_type": "drift_detected"
            },
            "group_by": ["session_id"],
            "aggregate": "count_distinct_session"
          },
          "sessions_recovered_after_drift": {
            "where": {
              "any": [
                { "event_type": "reentry_observed" },
                {
                  "all": [
                    { "event_type": "drift_detected" },
                    { "event_type": "continue_allowed" }
                  ]
                }
              ]
            },
            "group_by": ["session_id"],
            "aggregate": "count_distinct_session"
          }
        },
        "metrics": [
          {
            "name": "sessions_with_drift",
            "expression": "sessions_with_drift"
          },
          {
            "name": "sessions_recovered_after_drift",
            "expression": "sessions_recovered_after_drift"
          },
          {
            "name": "reentry_success_rate",
            "expression": "sessions_recovered_after_drift / nullif(sessions_with_drift, 0)"
          }
        ]
      }
    },
    {
      "id": "drift_repair_funnel",
      "type": "funnel",
      "title": "Drift → Repair → Reentry / Continue",
      "description": "Funnel-style view of how sessions progress from drift detection through repair and back to normal operation.",
      "stages": [
        {
          "id": "stage_drift",
          "label": "Drift Detected",
          "where": { "event_type": "drift_detected" }
        },
        {
          "id": "stage_repair",
          "label": "Repair Triggered",
          "where": { "event_type": "repair_triggered" }
        },
        {
          "id": "stage_reentry",
          "label": "Reentry Observed (Optional)",
          "where": { "event_type": "reentry_observed" }
        },
        {
          "id": "stage_continue",
          "label": "Continue Allowed",
          "where": { "event_type": "continue_allowed" }
        }
      ],
      "group_by": "session_id",
      "options": {
        "treat_reentry_as_optional": true
      }
    },
    {
      "id": "session_timeline_table",
      "type": "table",
      "title": "Session Timelines (Drift/Repair/Reentry-related)",
      "description": "Per-session event timelines focusing on drift, repair, and continuation phases.",
      "columns": [
        "timestamp",
        "session_id",
        "event_type",
        "pld.phase",
        "pld.code"
      ],
      "where": {
        "any": [
          { "event_type": "drift_detected" },
          { "event_type": "repair_triggered" },
          { "event_type": "reentry_observed" },
          { "event_type": "continue_allowed" }
        ]
      },
      "order_by": [
        { "field": "session_id", "direction": "asc" },
        { "field": "timestamp", "direction": "asc" }
      ]
    },
    {
      "id": "drift_repair_distribution",
      "type": "bar",
      "title": "Drift and Repair Events per Session",
      "description": "Count of drift and repair events by session for quick comparison.",
      "x_axis": "session_id",
      "series": [
        {
          "name": "drift_events",
          "where": { "pld.phase": "drift" },
          "aggregate": "count_events"
        },
        {
          "name": "repair_events",
          "where": { "pld.phase": "repair" },
          "aggregate": "count_events"
        }
      ]
    }
  ]
}
