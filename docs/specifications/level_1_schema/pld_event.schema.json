{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "PLD Runtime Event Schema",
  "description": "Hard invariant schema for PLD runtime event logging.",
  "type": "object",
  "required": [
    "schema_version",
    "event_id",
    "timestamp",
    "session_id",
    "turn_sequence",
    "source",
    "event_type",
    "pld",
    "payload",
    "ux"
  ],
  "properties": {
    "schema_version": {
      "type": "string",
      "enum": ["2.0"]
    },
    "event_id": {
      "type": "string",
      "description": "Unique identifier for the event (UUIDv4 recommended)."
    },
    "timestamp": {
      "type": "string",
      "format": "date-time"
    },
    "session_id": {
      "type": "string",
      "description": "Unique session identifier (UUID recommended)."
    },
    "turn_sequence": {
      "type": "integer",
      "minimum": 1,
      "description": "Monotonic 1-based turn index for ordering. Authoritative ordering key."
    },
    "turn_id": {
      "type": "string",
      "description": "Optional semantic turn identifier. Used for correlation; does not override ordering semantics defined by turn_sequence."
    },
    "source": {
      "type": "string",
      "enum": [
        "user",
        "assistant",
        "runtime",
        "controller",
        "detector",
        "system"
      ]
    },
    "event_type": {
      "type": "string",
      "enum": [
        "drift_detected",
        "drift_escalated",
        "repair_triggered",
        "repair_escalated",
        "reentry_observed",
        "continue_allowed",
        "continue_blocked",
        "failover_triggered",
        "latency_spike",
        "pause_detected",
        "fallback_executed",
        "handoff",
        "evaluation_pass",
        "evaluation_fail",
        "session_closed",
        "info"
      ]
    },
    "pld": {
      "type": "object",
      "required": ["phase", "code"],
      "properties": {
        "phase": {
          "type": "string",
          "enum": [
            "drift",
            "repair",
            "reentry",
            "continue",
            "outcome",
            "failover",
            "none"
          ]
        },
        "code": {
          "type": "string",
          "pattern": "^[A-Z][A-Z0-9]*(?:[0-9]+)?(?:_[a-z0-9]+(?:_[a-z0-9]+)*)?$",
          "description": "Classification code. For lifecycle phases (drift, repair, reentry, continue, outcome, failover), the prefix MUST be one of D/R/RE/C/O/F. For phase='none', lifecycle prefixes MUST NOT be used. Descriptor segment (if present) MUST be lowercase snake_case. A numeric classifier segment before the descriptor (e.g., '4' in 'D4_tool_error') is OPTIONAL. See docs/event_matrix.md for full normative rules."
        },
        "confidence": {
          "type": "number",
          "minimum": 0,
          "maximum": 1
        },
        "metadata": {
          "type": "object",
          "additionalProperties": true
        }
      }
    },
    "payload": {
      "type": "object",
      "additionalProperties": true
    },
    "runtime": {
      "type": "object",
      "properties": {
        "latency_ms": { "type": "number" },
        "model": { "type": "string" },
        "tool": {
          "type": "string",
          "description": "Only present if tool invocation occurred. If not used, omit."
        },
        "agent_state": { "type": "string" }
      },
      "additionalProperties": true
    },
    "ux": {
      "type": "object",
      "required": ["user_visible_state_change"],
      "properties": {
        "user_visible_state_change": { "type": "boolean" }
      },
      "additionalProperties": false
    },
    "metrics": {
      "type": "object",
      "additionalProperties": true
    },
    "extensions": {
      "type": "object",
      "description": "Experimental/non-standard fields with no backward compatibility guarantees. SHOULD NOT be relied on in production pipelines.",
      "additionalProperties": true
    }
  },
  "additionalProperties": false
}
